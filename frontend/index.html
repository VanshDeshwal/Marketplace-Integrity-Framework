<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Catalog Similarity Studio</title>
    <style>
      :root {
        --bg: #0b1020;
        --bg-elev: #0f172a;
        --card: #101827;
        --fg: #e5edf6;
        --muted: #9fb0c3;
        --border: #223047;
        --accent: #22d3ee;
        --accent-2: #6366f1;
        --ok: #22c55e;
        --warn: #f59e0b;
        --err: #ef4444;
      }

      .light {
        --bg: #f6f9fc;
        --bg-elev: #ffffff;
        --card: #ffffff;
        --fg: #0b1324;
        --muted: #566072;
        --border: #e5e7eb;
        --accent: #0ea5e9;
        --accent-2: #7c3aed;
        --ok: #16a34a;
        --warn: #d97706;
        --err: #dc2626;
      }

      html, body { height: 100%; }
      body {
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: radial-gradient(1200px 600px at 10% -10%, rgba(34,211,238,0.12), transparent),
                    radial-gradient(800px 500px at 110% 10%, rgba(99,102,241,0.10), transparent),
                    var(--bg);
        color: var(--fg);
        margin: 0;
      }
      .container { max-width: 1180px; margin: 0 auto; padding: 24px; }

      header {
        position: sticky; top: 0; z-index: 5;
        backdrop-filter: saturate(150%) blur(8px);
        background: color-mix(in oklab, var(--bg-elev) 78%, transparent);
        border-bottom: 1px solid var(--border);
      }
      .brand { display:flex; align-items:center; gap:10px; }
      .logo {
        width: 34px; height: 34px; border-radius: 10px;
        background: conic-gradient(from 140deg, var(--accent), var(--accent-2));
        box-shadow: 0 8px 20px rgba(34,211,238,.25);
      }
      h1 { font-size: 1.35rem; margin: 0; letter-spacing:.2px; }
      .sub { color: var(--muted); margin: 2px 0 0; font-size: .95rem; }

      .toolbar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
      .pill { padding:6px 10px; border-radius:999px; border:1px solid var(--border); color: var(--muted); background: var(--bg-elev); font-size:.9rem; }

      input, button, select { padding: 10px 12px; font-size: 1rem; border-radius:10px; border:1px solid var(--border); background:var(--bg-elev); color:var(--fg); }
      input[type="range"] { width: 220px; }
      label { color: var(--muted); font-size:.92rem; }
      .btn { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #051018; border:none; cursor:pointer; font-weight:600; }
      .btn:hover { filter: brightness(1.05); }
      .btn.ghost { background: transparent; color: var(--fg); border:1px solid var(--border); }

      .grid { display:grid; gap:12px; grid-template-columns: 1fr; }
      .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
      .card { background:var(--card); border:1px solid var(--border); border-radius: 14px; padding: 16px; margin: 12px 0; box-shadow: 0 6px 18px rgba(2,6,23,0.25); }
      .hidden { display:none; }
      .muted { color: var(--muted); }

      /* Dropzone */
      .dropzone { border: 1.5px dashed var(--border); border-radius: 12px; padding: 14px; text-align:center; color: var(--muted); cursor: pointer; background: color-mix(in oklab, var(--bg-elev) 92%, transparent); }
      .dropzone.drag { border-color: var(--accent); color: var(--fg); box-shadow: inset 0 0 0 2px color-mix(in oklab, var(--accent) 40%, transparent); }
      .thumb { width: 72px; height: 72px; border-radius: 10px; object-fit: cover; border:1px solid var(--border); }

      /* Results */
      #results { display:grid; gap:10px; grid-template-columns: 1fr; margin-bottom: 64px; }
      .result { display:grid; grid-template-columns: auto 1fr auto; gap:12px; align-items:center; border:1px solid var(--border); background:var(--bg-elev); padding:12px; border-radius:12px; }
      .score { display:flex; gap:6px; align-items:center; }
      .kvs { display:flex; flex-wrap:wrap; gap:6px; }
      .kv { background:var(--card); border:1px solid var(--border); color:var(--muted); border-radius: 999px; padding: 4px 8px; font-size:.85rem; }
      .decision-yes { color: var(--ok); }
      .decision-no { color: var(--err); }
      .json-btn { font-size:.85rem; }
      .thumb-sm { width: 56px; height: 56px; border-radius: 8px; object-fit: cover; border:1px solid var(--border); }

      /* Loader & toast */
      .spinner { width: 16px; height: 16px; border: 3px solid color-mix(in oklab, var(--accent) 35%, transparent); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; display:inline-block; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .toast { position: fixed; right: 16px; bottom: 16px; background: var(--bg-elev); border:1px solid var(--border); color: var(--fg); padding:10px 12px; border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,.3); }

      /* API status box */
      .api-box { width: 14px; height: 14px; border-radius: 4px; border: 1px solid var(--border); background: var(--err); cursor: pointer; }
      .api-box.ok { background: var(--ok); box-shadow: 0 0 0 2px color-mix(in oklab, var(--ok) 20%, transparent); }

      /* Sample gallery */
      .samples { display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:10px; }
      .sample-card { position:relative; border:1px solid var(--border); background: var(--bg-elev); border-radius:12px; overflow:hidden; cursor: grab; }
      .sample-card img { display:block; width:100%; height:120px; object-fit:cover; }
      .sample-meta { padding:8px; font-size:.86rem; color:var(--muted); height: 56px; overflow:hidden; }
      .sample-drag { position:absolute; top:8px; left:8px; background:rgba(15,23,42,0.7); color:#fff; font-size:.75rem; padding:3px 6px; border-radius:8px; border:1px solid var(--border); }
      @media (max-width: 1100px) { .samples { grid-template-columns: repeat(4, minmax(0,1fr)); } }
      @media (max-width: 780px) { .samples { grid-template-columns: repeat(3, minmax(0,1fr)); } }
      @media (max-width: 560px) { .samples { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    </style>
  </head>
  <body>
    <header>
      <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:14px;">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1>Catalog Similarity Studio</h1>
            <p class="sub">Fast duplicate detection, semantic search, and fraud insights</p>
          </div>
        </div>
        <div class="toolbar">
          <div class="pill muted">Environment: <span id="envLabel">detecting…</span></div>
          <div id="apiBox" class="api-box" title="Open API docs"></div>
          <button id="themeBtn" class="btn ghost" title="Toggle theme">Theme</button>
        </div>
      </div>
    </header>

    <main class="container">
      <section class="card" id="hero">
        <div class="row" style="justify-content:space-between; align-items:flex-start; gap:18px;">
          <div style="flex:1 1 520px; min-width:320px;">
            <h3 style="margin:0 0 6px 0">Duplicate & Similarity Checker</h3>
            <p class="muted" style="margin-top:0">Upload a product image and optionally add a title. We’ll find visually or textually similar items from the catalog and show why they match.</p>
            <form id="fusedOneForm" class="grid">
              <input id="oneTitle" placeholder="Optional title / description" />
              <div id="dropOne" class="dropzone">Drop an image here or click to upload</div>
              <input type="file" id="oneImage" accept="image/*" class="hidden" />
              <div class="row">
                <img id="onePreview" class="thumb hidden" alt="preview" />
                <label>Alpha (img vs text)</label>
                <input type="range" id="alphaOne" min="0" max="1" step="0.05" value="0.80" />
                <span class="pill" id="alphaOneVal">0.80</span>
                <label>Top K</label>
                <input type="number" id="topkOne" value="10" min="1" max="50" style="width:100px" />
                <button type="submit" class="btn">Find Similar</button>
              </div>
            </form>
            <div class="card" style="margin:14px 0 0 0;">
              <h4 style="margin:0 0 6px 0">How to read the results</h4>
              <ul class="muted" style="margin:8px 0 0 16px; padding:0 0 0 4px;">
                <li>Score near 1.00 means near-duplicate. 0.95+ is usually the same product.</li>
                <li>We show image similarity, text similarity, and an overall decision (duplicate/distinct).</li>
              </ul>
            </div>
          </div>
          <div style="flex:1 1 520px; min-width:300px;">
            <div class="row" style="justify-content:space-between;">
              <h3 style="margin:0;">Sample Gallery</h3>
              <div class="row" style="gap:8px;">
                <label>Count</label>
                <input id="sampleCount" type="number" value="12" min="4" max="60" style="width:90px" />
                <button id="randomizeBtn" class="btn">Randomize</button>
              </div>
            </div>
            <p class="muted" style="margin-top:6px">Drag any image from below into the dropzone to demo duplicates instantly.</p>
            <div id="samples" class="samples"></div>
          </div>
        </div>
      </section>

      <section class="card" id="advanced">
        <h3 style="margin-top:0">Advanced: Individual Title or Image Search</h3>
        <div class="grid">
          <form id="dupTitleForm" class="grid">
            <input id="title" placeholder="Enter product title" />
            <div class="row">
              <label>Top K</label>
              <input type="number" id="topkTitle" value="5" min="1" max="50" style="width:100px" />
              <button type="submit" class="btn">Search Title</button>
            </div>
          </form>
          <form id="dupImageForm" class="grid">
            <div id="dropImage" class="dropzone">Drop an image here or click to upload</div>
            <input type="file" id="image" accept="image/*" class="hidden" />
            <div class="row">
              <img id="imagePreview" class="thumb hidden" alt="preview" />
              <label>Top K</label>
              <input type="number" id="topkImage" value="5" min="1" max="50" style="width:100px" />
              <button type="submit" class="btn">Search Image</button>
            </div>
          </form>
        </div>
      </section>

      <section class="card" id="search-card">
        <h3 style="margin-top:0">Semantic Search</h3>
        <form id="searchForm" class="grid">
          <input id="searchTitle" placeholder="Search text (optional)" />
          <div id="dropSearch" class="dropzone">Drop an image here or click to upload</div>
          <input type="file" id="searchImage" accept="image/*" class="hidden" />
          <div class="row">
            <img id="searchPreview" class="thumb hidden" alt="preview" />
            <label>Alpha (img vs text)</label>
            <input type="range" id="alphaSearch" min="0" max="1" step="0.05" value="0.50" />
            <span class="pill" id="alphaSearchVal">0.50</span>
            <label>Top K</label>
            <input type="number" id="topkSearch" value="10" min="1" max="50" style="width:100px" />
            <button type="submit" class="btn">Search</button>
          </div>
        </form>
      </section>

      <section class="card" id="fraud-card">
        <h3 style="margin-top:0">Fraud Signals</h3>
        <div class="grid">
          <div class="row">
            <button id="fraudTop" class="btn">Top Seller Anomalies</button>
            <label>Top N</label>
            <input type="number" id="fraudTopN" value="20" min="1" max="200" style="width:100px" />
            <button id="fraudInsights" class="btn ghost" title="Heuristic insights">Seller Insights</button>
          </div>
          <div class="row">
            <input id="fraudSellerId" placeholder="Seller ID" style="max-width:240px;" />
            <button id="fraudOne" class="btn">Check Seller</button>
            <button id="fraudDupes" class="btn ghost">Duplicates</button>
            <label>Use</label>
            <select id="dupeUse">
              <option value="fused" selected>fused</option>
              <option value="text">text</option>
              <option value="image">image</option>
            </select>
            <label>Threshold</label>
            <input type="number" id="dupeThresh" value="0.8" step="0.01" min="0" max="1" style="width:100px" />
            <label>Top Pairs</label>
            <input type="number" id="dupeTop" value="50" min="1" max="500" style="width:100px" />
          </div>
        </div>
      </section>

      <div id="results"></div>
    </main>

    <div id="toast" class="toast hidden"></div>

    <script>
      // Utils
      const $ = (sel) => document.querySelector(sel)
      const el = (tag, cls) => { const d = document.createElement(tag); if (cls) d.className = cls; return d }
      const showToast = (msg, ms=2200) => { const t=$('#toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), ms) }

      // Theme
      const applyTheme = (mode) => { document.body.classList.toggle('light', mode === 'light'); localStorage.setItem('theme', mode) }
      const currentTheme = localStorage.getItem('theme') || 'dark'; applyTheme(currentTheme)
      $('#themeBtn').addEventListener('click', () => applyTheme(document.body.classList.contains('light') ? 'dark' : 'light'))
      // Auto-detect environment and API base
      const envLabel = document.getElementById('envLabel')
      const apiBox = document.getElementById('apiBox')
      const isLocalHost = ['localhost','127.0.0.1','::1'].includes(location.hostname)
      const isFile = location.protocol === 'file:'
      const IS_LOCAL = isLocalHost || isFile
      envLabel.textContent = IS_LOCAL ? 'local' : 'hosted'
  const API_BASE = IS_LOCAL ? 'http://localhost:8000' : 'https://api.marketplace.vanshdeshwal.dev'
  // Media base for images (Azure Blob in prod, local media server or backend fallback in dev)
  const MEDIA_BASE = IS_LOCAL ? (localStorage.getItem('mediaBase') || '') : 'https://assets.marketplace.vanshdeshwal.dev'
      const ping = async () => {
        try {
          const resp = await fetch(API_BASE + '/health', { cache:'no-store' })
          if (!resp.ok) throw new Error('bad status')
          await resp.json(); apiBox.classList.add('ok'); return true
        } catch {
          apiBox.classList.remove('ok'); return false
        }
      }
      apiBox.addEventListener('click', () => window.open(API_BASE + '/docs', '_blank'))
      ;(async () => { await ping(); setInterval(ping, 10000) })()

      // Dropzones with preview + programmatic drop from sample gallery
      const wireDrop = (zoneSel, inputSel, previewSel) => {
        const zone = $(zoneSel), input = $(inputSel), preview = $(previewSel)
        const openPicker = () => input.click()
        const setFile = (file) => {
          if (!file) return
          const url = URL.createObjectURL(file)
          preview.src = url; preview.classList.remove('hidden')
        }
        zone.addEventListener('click', openPicker)
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag') })
        zone.addEventListener('dragleave', () => zone.classList.remove('drag'))
        zone.addEventListener('drop', e => { e.preventDefault(); zone.classList.remove('drag'); const f = e.dataTransfer.files?.[0] || e.dataTransfer._sampleFile; if (f) { const dt = new DataTransfer(); dt.items.add(f); input.files = dt.files; setFile(f) } })
        input.addEventListener('change', e => setFile(e.target.files?.[0]))
        return { setFromBlob: (blob, name='sample.jpg') => { const file = new File([blob], name, { type: blob.type || 'image/jpeg' }); const dt = new DataTransfer(); dt.items.add(file); input.files = dt.files; const url = URL.createObjectURL(file); preview.src = url; preview.classList.remove('hidden') } }
      }
      const dropImage = wireDrop('#dropImage', '#image', '#imagePreview')
      const dropSearch = wireDrop('#dropSearch', '#searchImage', '#searchPreview')
      const dropOne = wireDrop('#dropOne', '#oneImage', '#onePreview')

      // Alpha live labels
      const alphaOne = $('#alphaOne'), alphaOneVal = $('#alphaOneVal');
      if (alphaOne) alphaOne.addEventListener('input', () => alphaOneVal.textContent = Number(alphaOne.value).toFixed(2))
      const alphaSearch = $('#alphaSearch'), alphaSearchVal = $('#alphaSearchVal');
      if (alphaSearch) alphaSearch.addEventListener('input', () => alphaSearchVal.textContent = Number(alphaSearch.value).toFixed(2))

      const imgSrc = (r) => {
        // Prefer direct image_url from backend if present (points to blob in prod)
        if (r.image_url) return r.image_url
        // Else, try media base + key
        if (MEDIA_BASE && r.image_key) return `${MEDIA_BASE}/${r.image_key}`
        // Fallback: backend image endpoint (dev only)
        return `${API_BASE}/image/${r.idx}`
      }

      // Sample gallery logic
      async function loadSamples() {
        const count = Math.max(4, Math.min(60, Number($('#sampleCount').value || 12)))
        try {
          const resp = await fetch(`${API_BASE}/samples?count=${encodeURIComponent(count)}`)
          const j = await resp.json()
          if (j.error) { $('#samples').innerHTML = `<div class='muted'>${j.error}</div>`; return }
          const box = $('#samples'); box.innerHTML = ''
          j.results.forEach(r => {
            const card = el('div', 'sample-card')
            const img = new Image(); img.src = imgSrc(r); img.draggable = true
            const meta = el('div', 'sample-meta'); meta.textContent = r.title || ''
            const tag = el('div', 'sample-drag'); tag.textContent = 'Drag to dropzone'
            card.appendChild(img); card.appendChild(meta); card.appendChild(tag)
            // enable drag into our dropzones by turning the remote image into a Blob
      img.addEventListener('dragstart', async (ev) => {
              try {
        const res = await fetch(img.src, { mode:'cors' })
                const blob = await res.blob()
                const file = new File([blob], `sample_${r.idx}.jpg`, { type: blob.type || 'image/jpeg' })
                // Stash file on dataTransfer for our drop handler
                ev.dataTransfer._sampleFile = file
              } catch (e) { /* ignore */ }
            })
            // quick action: click to use
            card.addEventListener('click', async () => {
              try {
        const res = await fetch(img.src, { mode:'cors' })
                const blob = await res.blob()
                dropOne.setFromBlob(blob, `sample_${r.idx}.jpg`)
                showToast('Loaded sample into checker')
              } catch (e) {}
            })
            box.appendChild(card)
          })
        } catch (e) {
          $('#samples').innerHTML = `<div class='muted'>Failed to load samples</div>`
        }
      }
      $('#randomizeBtn').addEventListener('click', (e) => { e.preventDefault(); loadSamples() })
      // load on start
      loadSamples()

      // Result rendering helpers
      const resBox = document.getElementById('results')
      const startLoading = (msg='Working...') => { resBox.innerHTML = `<div class=\"pill\"><span class=spinner></span> ${msg}</div>` }
      const kv = (k, v) => `<span class='kv'><b>${k}</b>: ${v}</span>`
      const pick = (obj, keys) => Object.fromEntries(Object.entries(obj || {}).filter(([k]) => keys.includes(k)))

  const renderDupTitle = (j) => {
        resBox.innerHTML = ''
        j.results.forEach(r => {
          const meta = r.meta || {}
          const row = el('div', 'result')
          row.innerHTML = `
    <img src="${imgSrc(r)}" class="thumb-sm" alt="thumb" onerror="this.style.display='none'"/>
            <div class='score'>${kv('idx', r.idx)} ${kv('score', Number(r.score).toFixed(4))}</div>
            <div class='kvs'>${Object.entries(pick(meta, ['title','product_id','label_group','seller_id']))
              .map(([k,v]) => kv(k, String(v))).join(' ')}</div>
            <div><button class='btn ghost json-btn'>JSON</button></div>`
          row.querySelector('.json-btn').addEventListener('click', () => navigator.clipboard.writeText(JSON.stringify(r, null, 2)).then(()=>showToast('Copied result JSON')))
          resBox.appendChild(row)
        })
      }

  const renderDupImage = (j) => {
        resBox.innerHTML = ''
        j.results.forEach(r => {
          const meta = r.meta || {}
          const row = el('div', 'result')
          row.innerHTML = `
    <img src="${imgSrc(r)}" class="thumb-sm" alt="thumb" onerror="this.style.display='none'"/>
            <div class='score'>${kv('idx', r.idx)} ${kv('score', Number(r.score).toFixed(4))}</div>
            <div class='kvs'>${Object.entries(pick(meta, ['title','product_id','label_group','seller_id']))
              .map(([k,v]) => kv(k, String(v))).join(' ')}</div>
            <div><button class='btn ghost json-btn'>JSON</button></div>`
          row.querySelector('.json-btn').addEventListener('click', () => navigator.clipboard.writeText(JSON.stringify(r, null, 2)).then(()=>showToast('Copied result JSON')))
          resBox.appendChild(row)
        })
      }

  const renderDupFused = (j) => {
        resBox.innerHTML = ''
        j.results.forEach(r => {
          const meta = r.meta || {}
          const row = el('div', 'result')
          const prob = r.prob !== undefined ? Number(r.prob).toFixed(4) : 'n/a'
          row.innerHTML = `
    <img src="${imgSrc(r)}" class="thumb-sm" alt="thumb" onerror="this.style.display='none'"/>
            <div class='score'>${kv('idx', r.idx)} ${kv('img', Number(r.image_sim ?? r.image_score ?? 0).toFixed(3))} ${kv('txt', Number(r.text_sim ?? r.text_score ?? 0).toFixed(3))}</div>
            <div class='kvs'>${kv('prob', prob)} <span class='${r.decision ? 'decision-yes' : 'decision-no'}'>${r.decision ? 'duplicate' : 'distinct'}</span> ${Object.entries(pick(meta, ['title','product_id','label_group','seller_id']))
              .map(([k,v]) => kv(k, String(v))).join(' ')}</div>
            <div><button class='btn ghost json-btn'>JSON</button></div>`
          row.querySelector('.json-btn').addEventListener('click', () => navigator.clipboard.writeText(JSON.stringify(r, null, 2)).then(()=>showToast('Copied result JSON')))
          resBox.appendChild(row)
        })
      }

  const renderSearch = (j) => {
        resBox.innerHTML = ''
        j.results.forEach(r => {
          const meta = r.meta || {}
          const row = el('div', 'result')
          row.innerHTML = `
    <img src="${imgSrc(r)}" class="thumb-sm" alt="thumb" onerror="this.style.display='none'"/>
            <div class='score'>${kv('idx', r.idx)} ${kv('fused', Number(r.fused).toFixed(4))}</div>
            <div class='kvs'>${kv('img', Number(r.image_score).toFixed(3))} ${kv('txt', Number(r.text_score).toFixed(3))} ${Object.entries(pick(meta, ['title','product_id','label_group','seller_id']))
              .map(([k,v]) => kv(k, String(v))).join(' ')}</div>
            <div><button class='btn ghost json-btn'>JSON</button></div>`
          row.querySelector('.json-btn').addEventListener('click', () => navigator.clipboard.writeText(JSON.stringify(r, null, 2)).then(()=>showToast('Copied result JSON')))
          resBox.appendChild(row)
        })
      }

      // Forms
      const titleForm = document.getElementById('dupTitleForm')
      titleForm.addEventListener('submit', async (e) => {
        e.preventDefault()
        const title = document.getElementById('title').value
        const topk = Number(document.getElementById('topkTitle').value || 5)
        const fd = new FormData()
        fd.append('title', title)
        fd.append('top_k', topk)
        startLoading('Searching title...')
        try {
          const resp = await fetch(API_BASE + '/dedup/title', { method: 'POST', body: fd })
          const j = await resp.json()
          if (j.error) { resBox.innerHTML = '<b>Error:</b> ' + j.error; return }
          renderDupTitle(j)
        } catch (err) { resBox.innerHTML = '<b>Fetch error:</b> ' + err }
      })

      const imageForm = document.getElementById('dupImageForm')
      imageForm.addEventListener('submit', async (e) => {
        e.preventDefault()
        const file = document.getElementById('image').files[0]
        const topk = Number(document.getElementById('topkImage').value || 5)
        const fd = new FormData()
        if (file) fd.append('file', file)
        fd.append('top_k', topk)
        startLoading('Searching image...')
        try {
          const resp = await fetch(API_BASE + '/dedup/image', { method: 'POST', body: fd })
          const j = await resp.json()
          if (j.error) { resBox.innerHTML = '<b>Error:</b> ' + j.error; return }
          renderDupImage(j)
        } catch (err) { resBox.innerHTML = '<b>Fetch error:</b> ' + err }
      })

      const fusedOneForm = document.getElementById('fusedOneForm')
      fusedOneForm.addEventListener('submit', async (e) => {
        e.preventDefault()
        const title = document.getElementById('oneTitle').value
        const file = document.getElementById('oneImage').files[0]
        const topk = Number(document.getElementById('topkOne').value || 10)
        const alpha = Number(document.getElementById('alphaOne').value)
        const fd = new FormData()
        if (title) fd.append('title', title)
        if (file) fd.append('file', file)
        fd.append('top_k', topk)
        fd.append('alpha', alpha)
        startLoading('Finding similar...')
        try {
          const resp = await fetch(API_BASE + '/dedup/fused', { method: 'POST', body: fd })
          const j = await resp.json()
          if (j.error) { resBox.innerHTML = '<b>Error:</b> ' + j.error; return }
          renderDupFused(j)
        } catch (err) { resBox.innerHTML = '<b>Fetch error:</b> ' + err }
      })

      const searchForm = document.getElementById('searchForm')
      searchForm.addEventListener('submit', async (e) => {
        e.preventDefault()
        const title = document.getElementById('searchTitle').value
        const file = document.getElementById('searchImage').files[0]
        const topk = Number(document.getElementById('topkSearch').value || 10)
        const alpha = Number(document.getElementById('alphaSearch').value)
        const fd = new FormData()
        if (title) fd.append('title', title)
        if (file) fd.append('file', file)
        fd.append('top_k', topk)
        fd.append('alpha', alpha)
        startLoading('Searching...')
        try {
          const resp = await fetch(API_BASE + '/search', { method: 'POST', body: fd })
          const j = await resp.json()
          if (j.error) { resBox.innerHTML = '<b>Error:</b> ' + j.error; return }
          renderSearch(j)
        } catch (err) { resBox.innerHTML = '<b>Fetch error:</b> ' + err }
      })

      // Fraud
      const fraudTop = document.getElementById('fraudTop')
      const fraudOne = document.getElementById('fraudOne')
      const fraudInsights = document.getElementById('fraudInsights')
      const fraudDupes = document.getElementById('fraudDupes')
      fraudTop.addEventListener('click', async () => {
        startLoading('Computing anomalies...')
        try {
          const n = Number(document.getElementById('fraudTopN').value || 20)
          const resp = await fetch(API_BASE + `/fraud/sellers/anomaly?n=${encodeURIComponent(n)}`)
          const j = await resp.json()
          if (j.error) { resBox.innerHTML = '<b>Error:</b> ' + j.error; return }
          resBox.innerHTML = ''
          j.results.forEach(r => {
            const row = el('div', 'result')
            row.innerHTML = `<div class='score'>${kv('seller', r.seller_id)}</div><div class='kvs'>${kv('score', Number(r.anomaly_score).toFixed(4))} ${kv('count', r.count)}</div><div></div>`
            resBox.appendChild(row)
          })
        } catch (err) { resBox.innerHTML = '<b>Fetch error:</b> ' + err }
      })
      fraudInsights.addEventListener('click', async () => {
        startLoading('Building insights...')
        try {
          const n = Number(document.getElementById('fraudTopN').value || 20)
          const resp = await fetch(API_BASE + `/fraud/sellers/insights?n=${encodeURIComponent(n)}`)
          const j = await resp.json()
          if (j.error) { resBox.innerHTML = '<b>Error:</b> ' + j.error; return }
          resBox.innerHTML = ''
          j.results.forEach(r => {
            const row = el('div', 'result')
            row.innerHTML = `<div class='score'>${kv('seller', r.seller_id)}</div><div class='kvs'>${kv('risk', Number(r.risk_score).toFixed(3))} ${kv('count', r.count)} ${kv('mt', Number(r.mean_text_sim).toFixed(3))} ${kv('mi', Number(r.mean_image_sim).toFixed(3))} ${kv('entropy', Number(r.label_entropy).toFixed(2))} ${kv('uniq_title', Number(r.unique_title_ratio).toFixed(2))}</div><div></div>`
            resBox.appendChild(row)
          })
        } catch (err) { resBox.innerHTML = '<b>Fetch error:</b> ' + err }
      })
      fraudOne.addEventListener('click', async () => {
        const sid = document.getElementById('fraudSellerId').value
        startLoading('Checking seller...')
        try {
          const resp = await fetch(API_BASE + `/fraud/seller/${encodeURIComponent(sid)}`)
          const j = await resp.json()
          if (j.error) { resBox.innerHTML = '<b>Error:</b> ' + j.error; return }
          resBox.innerHTML = `<div class='result'><div class='score'>${kv('seller', j.seller_id)}</div><div class='kvs'>${kv('score', Number(j.anomaly_score).toFixed(4))} ${kv('count', j.count)}</div><div></div></div>`
        } catch (err) { resBox.innerHTML = '<b>Fetch error:</b> ' + err }
      })
  fraudDupes.addEventListener('click', async () => {
        const sid = document.getElementById('fraudSellerId').value
        const use = document.getElementById('dupeUse').value
        const thr = Number(document.getElementById('dupeThresh').value || 0.8)
        const top = Number(document.getElementById('dupeTop').value || 50)
        startLoading('Finding duplicates...')
        try {
          const url = API_BASE + `/fraud/seller/${encodeURIComponent(sid)}/duplicates?use=${encodeURIComponent(use)}&threshold=${encodeURIComponent(thr)}&top=${encodeURIComponent(top)}`
          const resp = await fetch(url)
          const j = await resp.json()
          if (j.error) { resBox.innerHTML = '<b>Error:</b> ' + j.error; return }
          resBox.innerHTML = ''
          j.results.forEach(p => {
            const row = el('div', 'result')
            row.innerHTML = `
      <img src="${p.a_url || (MEDIA_BASE && p.a_key ? MEDIA_BASE + '/' + p.a_key : API_BASE + '/image/' + p.a)}" class="thumb-sm" alt="thumb" onerror="this.style.display='none'"/>
              <div class='kvs'>${kv('a', p.a)} ${kv('b', p.b)} ${kv('score', Number(p.score).toFixed(3))}</div>
              <div class='kvs'>${p.a_meta ? kv('a_title', p.a_meta.title ?? '') : ''} ${p.b_meta ? kv('b_title', p.b_meta.title ?? '') : ''}</div>`
            resBox.appendChild(row)
          })
        } catch (err) { resBox.innerHTML = '<b>Fetch error:</b> ' + err }
      })
    </script>
  </body>
</html>
